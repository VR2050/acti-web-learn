# ä½¿ç”¨ Rust å’Œ Rayon å®ç°å¤šçº¿ç¨‹ MD5 æ‘˜è¦è®¡ç®—

åœ¨ç°ä»£çš„é«˜æ€§èƒ½ç¼–ç¨‹ä¸­ï¼Œåˆ©ç”¨å¤šæ ¸ CPU çš„èƒ½åŠ›æ¥åŠ é€Ÿä»»åŠ¡å¤„ç†å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Rust æ˜¯ä¸€ç§ç³»ç»Ÿçº§è¯­è¨€ï¼Œä»¥å…¶å®‰å…¨æ€§å’Œæ€§èƒ½è‘—ç§°ï¼Œè€Œ [Rayon](https://github.com/rayon-rs/rayon) æ˜¯ä¸€ä¸ªç”¨äºæ•°æ®å¹¶è¡ŒåŒ–çš„ Rust åº“ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å°†ä¸²è¡Œæ“ä½œè½¬æ¢ä¸ºå¹¶è¡Œæ‰§è¡Œã€‚

æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Rust å’Œ Rayon å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹çš„ MD5 å“ˆå¸Œæ‘˜è¦è®¡ç®—ç¨‹åºï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ–‡ä»¶åˆ—è¡¨çš„å“ˆå¸Œæ ¡éªŒåœºæ™¯ã€‚

---

## ğŸ§© é¡¹ç›®ç›®æ ‡

ç¼–å†™ä¸€ä¸ª Rust ç¨‹åºï¼Œèƒ½å¤Ÿï¼š

- æ¥æ”¶ä¸€ç»„æ–‡ä»¶è·¯å¾„ï¼›
- å¹¶è¡Œåœ°ä¸ºæ¯ä¸ªæ–‡ä»¶è®¡ç®—å…¶ MD5 å“ˆå¸Œå€¼ï¼›
- è¾“å‡ºæ¯ä¸ªæ–‡ä»¶çš„è·¯å¾„å’Œå¯¹åº”çš„ MD5 å€¼ã€‚

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Rust**ï¼šç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€ï¼Œä¿è¯å†…å­˜å®‰å…¨å’Œé«˜æ€§èƒ½ï¼›
- **Rayon**ï¼šç”¨äºå¹¶è¡Œè¿­ä»£å™¨ï¼›
- **md5 crate** æˆ– **digest + md5-crate**ï¼šç”¨äº MD5 è®¡ç®—ï¼›
- **æ ‡å‡†åº“ä¸­çš„ fsã€ioã€path ç­‰æ¨¡å—**ï¼šç”¨äºæ–‡ä»¶è¯»å–ã€‚

---

## ğŸ“¦ æ·»åŠ ä¾èµ–é¡¹

é¦–å…ˆï¼Œåœ¨ä½ çš„ `Cargo.toml` ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```toml
[dependencies]
rayon = "1.5"
md5 = "0.7"
```

æˆ–è€…ä½¿ç”¨æ›´é€šç”¨çš„ digest traitï¼ˆå¯é€‰ï¼‰ï¼š

```toml
[dependencies]
rayon = "1.5"
digest = "0.10"
md5 = "0.10"
```

---

## ğŸ§± æ ¸å¿ƒç»“æ„è®¾è®¡

æˆ‘ä»¬å°†æ„å»ºå¦‚ä¸‹ç»„ä»¶ï¼š

1. è·å–æ‰€æœ‰å¾…å¤„ç†çš„æ–‡ä»¶è·¯å¾„ï¼›
2. ä½¿ç”¨ Rayon çš„ `.par_iter()` å¹¶è¡Œéå†ï¼›
3. ä¸ºæ¯ä¸ªæ–‡ä»¶è®¡ç®— MD5ï¼›
4. æ”¶é›†ç»“æœå¹¶è¾“å‡ºã€‚

---

## ğŸ§ª ç¤ºä¾‹ä»£ç 

### âœ… 1. å®šä¹‰å‡½æ•°ï¼šè®¡ç®—å•ä¸ªæ–‡ä»¶çš„ MD5

```rust
use std::fs::File;
use std::io::{Read, Result};
use md5::{Md5, Digest};

fn compute_md5(file_path: &str) -> Result<String> {
    let mut file = File::open(file_path)?;
    let mut hasher = Md5::new();
    let mut buffer = vec![0; 1024 * 1024]; // 1MB ç¼“å†²åŒº

    loop {
        let bytes_read = file.read(&mut buffer)?;
        if bytes_read == 0 {
            break;
        }
        hasher.update(&buffer[..bytes_read]);
    }

    let result = hasher.finalize();
    Ok(format!("{:x}", result))
}
```

---

### âœ… 2. ä¸»ç¨‹åºé€»è¾‘

```rust
use rayon::prelude::*;
use std::path::Path;
use std::fs;

fn main() {
    let dir_path = "./test_files"; // æ›¿æ¢ä¸ºä½ è‡ªå·±çš„æµ‹è¯•ç›®å½•

    // è·å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶è·¯å¾„
    let paths: Vec<_> = fs::read_dir(dir_path)
        .expect("æ— æ³•è¯»å–ç›®å½•")
        .map(|res| res.expect("è·å–è·¯å¾„å¤±è´¥").path())
        .filter(|p| p.is_file())
        .collect();

    // ä½¿ç”¨ Rayon å¹¶è¡Œå¤„ç†
    let results: Vec<_> = paths
        .par_iter()
        .map(|path| {
            let path_str = path.to_str().unwrap().to_string();
            match compute_md5(&path_str) {
                Ok(md5) => format!("{} => {}", path_str, md5),
                Err(e) => format!("{} => Error: {:?}", path_str, e),
            }
        })
        .collect();

    // è¾“å‡ºç»“æœ
    for line in results {
        println!("{}", line);
    }
}
```

---

## ğŸ” ä¼˜åŒ–å»ºè®®

- **ç¼“å†²åŒºå¤§å°**ï¼šå½“å‰è®¾ç½®ä¸º 1MBï¼Œå¯æ ¹æ®ç£ç›˜ IO ç‰¹æ€§è°ƒæ•´ï¼›
- **é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼šå¯ä»¥å®šä¹‰è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼›
- **è¿›åº¦æ¡**ï¼šå¯¹äºå¤§é‡æ–‡ä»¶ï¼Œå¯ç»“åˆ `indicatif` crate æ˜¾ç¤ºè¿›åº¦ï¼›
- **å¤§æ–‡ä»¶æ”¯æŒ**ï¼šè‹¥æ–‡ä»¶æå¤§ï¼Œè€ƒè™‘åˆ†å— hash + åˆå¹¶ç­–ç•¥ï¼ˆMD5 ä¸æ”¯æŒå¢é‡åˆå¹¶ï¼‰ï¼›
- **è·¨å¹³å°å…¼å®¹æ€§**ï¼šç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®å¤„ç†ã€‚

---

## ğŸ§µ Rayon å¦‚ä½•å·¥ä½œï¼Ÿ

Rayon çš„æ ¸å¿ƒæ˜¯ **work-stealing çº¿ç¨‹æ± **ï¼Œå®ƒå…è®¸ä½ åœ¨ä¸æ˜¾å¼åˆ›å»ºçº¿ç¨‹çš„æƒ…å†µä¸‹è‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°å¤šä¸ª CPU æ ¸å¿ƒä¸Šã€‚é€šè¿‡ `.par_iter()`ï¼Œä½ å¯ä»¥å°†ä¸€ä¸ªæ™®é€šçš„è¿­ä»£å™¨å˜ä¸ºå¹¶è¡Œç‰ˆæœ¬ã€‚

ä¾‹å¦‚ï¼š

```rust
(0..100).into_par_iter().for_each(|i| {
    println!("Processing {} on thread {:?}", i, std::thread::current().id());
});
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”ï¼ˆç¤ºä¾‹ï¼‰

| æ–‡ä»¶æ•°é‡ | å•çº¿ç¨‹è€—æ—¶ | å¤šçº¿ç¨‹ï¼ˆRayonï¼‰è€—æ—¶ |
|----------|-------------|----------------------|
| 10       | 1.2s        | 0.6s                 |
| 100      | 12s         | 3.5s                 |
| 1000     | 120s        | 20s                  |

*æ³¨æ„ï¼šå®é™…æ€§èƒ½å–å†³äºç£ç›˜ I/O å’Œ CPU æ•°é‡ã€‚*

---

## ğŸ§· å°ç»“

é€šè¿‡ Rust + Rayon çš„ç»„åˆï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨ã€å¹¶å‘çš„ MD5 å“ˆå¸Œè®¡ç®—å·¥å…·ã€‚è¯¥æ–¹æ³•å¯ç”¨äºï¼š

- æ•°æ®å®Œæ•´æ€§æ ¡éªŒï¼›
- æ–‡ä»¶å»é‡ï¼›
- æ‰¹é‡å¤„ç†æ—¥å¿—æˆ–é…ç½®æ–‡ä»¶ï¼›
- æ„å»ºæœ¬åœ°æ–‡ä»¶æŒ‡çº¹æ•°æ®åº“ç­‰ã€‚

Rayon æä¾›äº†ç®€å•æ˜“ç”¨çš„æ¥å£ï¼Œä½¿å¾—å¤šçº¿ç¨‹ç¼–ç¨‹ä¸å†æ˜¯â€œé«˜é£é™©â€æ“ä½œï¼Œè€Œæˆä¸º Rust ç”Ÿæ€ä¸­çš„è‡ªç„¶å»¶ä¼¸ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Rayon GitHub](https://github.com/rayon-rs/rayon)
- [Rust MD5 Crate](https://crates.io/crates/md5)
- [Rust å¹¶å‘ç¼–ç¨‹æŒ‡å—](https://kaisery.github.io/trpl-zh-cn/)
- [Rust ä¸­æ–‡ç¤¾åŒº](https://rustlang.cn/)

---

å¦‚æœä½ å–œæ¬¢è¿™ç±»æ–‡ç« ï¼Œæ¬¢è¿å…³æ³¨æˆ‘è·å–æ›´å¤š Rust é«˜æ€§èƒ½ç¼–ç¨‹å®è·µå†…å®¹ï¼ğŸš€

--- 

âœ… æ–‡ç« ä½œè€…ï¼šQwen  
ğŸ“… æ—¥æœŸï¼š2025å¹´5æœˆ15æ—¥  
ğŸ·ï¸ æ ‡ç­¾ï¼šRustã€Rayonã€MD5ã€å¤šçº¿ç¨‹ã€é«˜æ€§èƒ½ã€å¹¶è¡Œè®¡ç®—